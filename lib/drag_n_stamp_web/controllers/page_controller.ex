defmodule DragNStampWeb.PageController do
  use DragNStampWeb, :controller

  def home(conn, _params) do
    # The home page is often custom made,
    # so skip the default app layout.
    bookmarklet_code = "javascript:(function(){function showCustomAlert(title,message,type){var overlay=document.createElement('div');overlay.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999999;display:flex;align-items:center;justify-content:center;font-family:system-ui,-apple-system,sans-serif';var modal=document.createElement('div');modal.style.cssText='background:white;padding:24px;border-radius:12px;box-shadow:0 25px 50px rgba(0,0,0,0.25);max-width:500px;width:90%;max-height:80vh;overflow-y:auto';var header=document.createElement('div');header.style.cssText='display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb';var icon=document.createElement('div');icon.style.cssText='width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;color:white';if(type==='success'){icon.style.background='#10b981';icon.innerHTML='✓'}else if(type==='error'){icon.style.background='#ef4444';icon.innerHTML='✕'}else{icon.style.background='#3b82f6';icon.innerHTML='i'}var titleEl=document.createElement('h3');titleEl.style.cssText='margin:0;font-size:18px;font-weight:600;color:#111827';titleEl.textContent=title;header.appendChild(icon);header.appendChild(titleEl);var content=document.createElement('div');content.style.cssText='color:#374151;line-height:1.5;margin-bottom:20px;white-space:pre-wrap';content.textContent=message;var button=document.createElement('button');button.style.cssText='background:#3b82f6;color:white;border:none;padding:10px 20px;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;float:right';button.textContent='OK';button.onclick=function(){overlay.remove()};modal.appendChild(header);modal.appendChild(content);modal.appendChild(button);overlay.appendChild(modal);document.body.appendChild(overlay);overlay.onclick=function(e){if(e.target===overlay)overlay.remove()}}var e='http://localhost:4000/api/gemini',u=window.location.href,y=u.indexOf('youtube.com')>-1||u.indexOf('youtu.be')>-1||u.indexOf('m.youtube.com')>-1;if(!y){showCustomAlert('YouTube Required','This bookmarklet only works on YouTube videos!','error');return;}showCustomAlert('Processing...','Analyzing video and generating timestamps. This may take up to 5 minutes.','info');var username='anonymous',channelName='anonymous';try{console.log('Attempting to extract username and channel name...');var handleEl=document.querySelector('#channel-handle');console.log('Channel handle element:',handleEl);if(handleEl){var handleText=handleEl.textContent||handleEl.innerText||'';console.log('Handle text found:',handleText);if(handleText){username=handleText.trim();if(username.startsWith('@'))username=username.substring(1);}}console.log('Final username:',username);var channelSelectors=['#channel-name a','#text a','.ytd-channel-name a','[class*=\"channel\"] a','.owner-text a','.ytd-video-owner-renderer a'];for(var i=0;i<channelSelectors.length;i++){var chEl=document.querySelector(channelSelectors[i]);if(chEl&&chEl.textContent){channelName=chEl.textContent.trim();console.log('Channel name found with selector',channelSelectors[i],':',channelName);break;}}console.log('Final channel name:',channelName);}catch(x){console.log('Error extracting channel info:',x);}fetch(e,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({channel_name:channelName,username:username,url:u})}).then(function(r){return r.json();}).then(function(d){var message='Video: '+u+'\\nChannel: '+channelName+'\\nUsername: '+username+'\\n\\nTimestamps:\\n'+d.response;showCustomAlert('Timestamps Generated!',message,'success');console.log('Gemini Response:',d);}).catch(function(er){showCustomAlert('Error','Failed to generate timestamps. Check console for details.','error');console.error('Error:',er);});})();"
    
    render(conn, :home, layout: false, bookmarklet_code: bookmarklet_code)
  end
end
